<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Riskless Messenger</title>
  <style>
    body {
      background: #000;
      color: #0cf;
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }
    #friend-tag {
      font-size: 14px;
      color: #888;
      margin-bottom: 20px;
    }
    input, button {
      padding: 8px;
      margin: 5px;
      border: none;
      border-radius: 4px;
    }
    input {
      background: #111;
      color: #0cf;
    }
    button {
      background: #222;
      color: #0cf;
      cursor: pointer;
    }
    button:hover {
      background: #444;
    }
    .message-box {
      margin-top: 20px;
    }
    .message {
      background: #111;
      padding: 10px;
      margin-bottom: 6px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>ðŸ’¬ Riskless Messenger</h1>
  <div id="friend-tag">Loading account...</div>

  <input type="text" id="friendInput" placeholder="Friend username" />
  <button onclick="addFriend()">Add Friend</button>

  <br><br>
  <input type="text" id="messageInput" placeholder="Type a message..." />
  <button onclick="sendMessage()">Send</button>

  <div class="message-box" id="messageBox"></div>

  <script>
    const raw = localStorage.getItem('accountinfo');
    let account = null;
    try {
      account = JSON.parse(raw);
    } catch {}
    if (!account || !account.username) {
      location.replace('login.html');
    }

    const username = account.username;
    document.getElementById('friend-tag').textContent = 'Logged in as: ' + username;

    let currentFriend = null;

    function addFriend() {
      const friend = document.getElementById('friendInput').value.trim();
      if (!friend || friend === username) return;

      currentFriend = friend;

      // Save friend list
      const key = `friends-${username}`;
      const friends = JSON.parse(localStorage.getItem(key) || '[]');
      if (!friends.includes(friend)) {
        friends.push(friend);
        localStorage.setItem(key, JSON.stringify(friends));
      }

      // Send notification to friend
      const notifyKey = `notifications-${friend}`;
      const notifications = JSON.parse(localStorage.getItem(notifyKey) || '[]');
      notifications.push({ type: 'friend-request', from: username, time: Date.now() });
      localStorage.setItem(notifyKey, JSON.stringify(notifications));

      alert(`Friend added and notification sent to ${friend}`);
    }

    function sendMessage() {
      const text = document.getElementById('messageInput').value.trim();
      if (!text || !currentFriend) return;

      const threadKey = `thread-${username}-${currentFriend}`;
      const reverseKey = `thread-${currentFriend}-${username}`;

      const message = {
        from: username,
        to: currentFriend,
        text,
        time: Date.now()
      };

      // Save to both threads
      const thread = JSON.parse(localStorage.getItem(threadKey) || '[]');
      thread.push(message);
      localStorage.setItem(threadKey, JSON.stringify(thread));

      const reverse = JSON.parse(localStorage.getItem(reverseKey) || '[]');
      reverse.push(message);
      localStorage.setItem(reverseKey, JSON.stringify(reverse));

      document.getElementById('messageInput').value = '';
      renderMessages(thread);
    }

    function renderMessages(thread) {
      const box = document.getElementById('messageBox');
      box.innerHTML = '';
      thread.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'message';
        div.textContent = `${msg.from}: ${msg.text}`;
        box.appendChild(div);
      });
    }
  </script>
</body>
</html>